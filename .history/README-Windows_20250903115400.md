# Impresora Local - Sistema de Sincronizaci√≥n Autom√°tica para Windows

Sistema de impresi√≥n de tickets para cocina y parrilla con sincronizaci√≥n autom√°tica entre servidor y cliente, adaptado para Windows.

## üöÄ Caracter√≠sticas

- **Impresi√≥n autom√°tica** de tickets para cocina y parrilla
- **Sincronizaci√≥n autom√°tica** cada 5 minutos desde GitHub
- **Gesti√≥n de procesos** con Node.js nativo
- **Reinicio autom√°tico** del servicio despu√©s de actualizaciones
- **Logs detallados** de todas las operaciones
- **Configuraci√≥n persistente** entre actualizaciones
- **Scripts nativos de Windows** (.bat)
- **Tarea programada** para auto-actualizaci√≥n
- **Integraci√≥n con ngrok** para acceso externo

## üìã Requisitos

### En tu PC (Servidor de Desarrollo)
- Git configurado con acceso a GitHub
- Node.js 18+ instalado
- Acceso a internet para subir cambios

### En la PC del Cliente (Windows)
- Windows 10/11
- Git para Windows instalado
- Node.js 18+ instalado
- ngrok instalado (opcional, para acceso externo)
- Permisos de administrador

## üõ†Ô∏è Instalaci√≥n

### 1. Configuraci√≥n Inicial en tu PC

1. **Clonar el repositorio existente:**
   ```bash
   # Clonar el repositorio existente
   git clone https://github.com/francoluca35/impresora-local.git
   cd impresora-local
   ```

2. **Copiar archivos del proyecto:**
   ```bash
   # Copiar todos los archivos de tu proyecto actual
   # (incluyendo index.js, package.json, y todos los scripts)
   ```

3. **Configurar Git:**
   ```bash
   git add .
   git commit -m "Configuraci√≥n inicial"
   git push origin main
   ```

### 2. Configuraci√≥n en la PC del Cliente (Windows)

1. **Instalar dependencias previas:**
   - **Git**: Descargar desde [https://git-scm.com/download/win](https://git-scm.com/download/win)
   - **Node.js**: Descargar desde [https://nodejs.org/](https://nodejs.org/)

2. **Descargar y ejecutar el script de configuraci√≥n:**
   ```cmd
   # Descargar el script (ejecutar como administrador)
   # Ejecutar CMD como administrador
   cd C:\Users\Administrator
   
   # Descargar setup-cliente-ngrok.bat desde GitHub
   # O copiarlo desde tu PC
   
   # Ejecutar el script
   setup-cliente-ngrok.bat
   ```

3. **El script configurar√° autom√°ticamente:**
   - Directorio de instalaci√≥n en `C:\Users\Administrator\impresora-local`
   - Repositorio Git clonado
   - Dependencias de Node.js instaladas
   - Integraci√≥n con ngrok configurada
   - Tarea programada para auto-actualizaci√≥n cada 5 minutos
   - Archivos de control (.bat) para gesti√≥n del servicio

## üîÑ Flujo de Sincronizaci√≥n

### En tu PC (Desarrollo):
1. Hacer cambios en el c√≥digo
2. Ejecutar `./deploy.sh` (o `deploy.bat` en Windows)
3. Los cambios se suben a GitHub autom√°ticamente

### En la PC del Cliente (Windows):
1. Cada 5 minutos se ejecuta `auto-update.bat` v√≠a Task Scheduler
2. El script:
   - Verifica si hay cambios en GitHub
   - Si hay cambios:
     * Descarga el c√≥digo nuevo
     * Instala dependencias si es necesario
     * Reinicia el servicio PM2
     * Preserva la configuraci√≥n local

## üìÅ Estructura de Archivos en Windows

```
C:\Users\Administrator\impresora-local\
‚îú‚îÄ‚îÄ impresora-local\           # Repositorio clonado
‚îÇ   ‚îú‚îÄ‚îÄ index.js              # Servidor principal
‚îÇ   ‚îú‚îÄ‚îÄ package.json          # Dependencias
‚îÇ   ‚îú‚îÄ‚îÄ auto-update.bat       # Script de auto-actualizaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ config.json           # Configuraci√≥n
‚îú‚îÄ‚îÄ start-impresora-ngrok.bat # Iniciar servicio + ngrok
‚îú‚îÄ‚îÄ stop-impresora.bat        # Parar servicio
‚îú‚îÄ‚îÄ restart-impresora.bat     # Reiniciar servicio
‚îú‚îÄ‚îÄ status-impresora.bat      # Ver estado
‚îî‚îÄ‚îÄ logs-update.bat           # Ver logs de actualizaci√≥n
```

## üéØ Uso

### Desplegar Cambios (Tu PC)
```bash
# En Linux/Mac:
./deploy.sh

# En Windows:
deploy.bat
```

### Control del Servicio (Cliente Windows)
```cmd
# Iniciar servicio + ngrok
C:\Users\Administrator\impresora-local\start-impresora-ngrok.bat

# Parar servicio
C:\Users\Administrator\impresora-local\stop-impresora.bat

# Reiniciar servicio
C:\Users\Administrator\impresora-local\restart-impresora.bat

# Ver estado
C:\Users\Administrator\impresora-local\status-impresora.bat

# Ver logs de actualizaci√≥n
C:\Users\Administrator\impresora-local\logs-update.bat
```

## ‚öôÔ∏è Configuraci√≥n

### Personalizar Rutas
Edita los archivos de configuraci√≥n seg√∫n tu entorno:

- **auto-update.bat**: Cambia `REPO_DIR` y `LOG_FILE`
- **setup-cliente-windows.bat**: Cambia `REPO_URL` e `INSTALL_DIR`

### Cambiar Frecuencia de Actualizaci√≥n
En el cliente Windows, edita la tarea programada:
```cmd
# Ver tareas programadas
schtasks /query /tn "ImpresoraLocal-AutoUpdate"

# Eliminar tarea existente
schtasks /delete /tn "ImpresoraLocal-AutoUpdate" /f

# Crear nueva tarea con intervalo diferente (ej: cada 10 minutos)
schtasks /create /tn "ImpresoraLocal-AutoUpdate" /tr "C:\Users\Administrador\impresora-local\impresora-local\auto-update.bat" /sc minute /mo 10 /ru "Administrador" /f
```

## üîç Monitoreo

### Verificar Estado del Servicio
```cmd
# Ver estado de los procesos
C:\Users\Administrator\impresora-local\status-impresora.bat

# Ver procesos en tiempo real
tasklist /fi "imagename eq node.exe"
tasklist /fi "imagename eq ngrok.exe"
```

### Ver Logs de Actualizaci√≥n
```cmd
# Ver logs de actualizaci√≥n
type C:\Users\Administrator\impresora-local\impresora-local\update.log

# O usar el script
C:\Users\Administrator\impresora-local\logs-update.bat
```

### Verificar √öltima Actualizaci√≥n
```cmd
# Ver √∫ltimo commit
cd C:\Users\Administrator\impresora-local\impresora-local
git log -1 --oneline

# Ver estado del repositorio
git status
```

## üö® Soluci√≥n de Problemas

### El servicio no se actualiza
1. Verificar logs: `type C:\Users\Administrator\impresora-local\impresora-local\update.log`
2. Verificar tarea programada: `schtasks /query /tn "ImpresoraLocal-AutoUpdate"`
3. Verificar permisos: Ejecutar CMD como administrador

### Error de permisos
```cmd
# Ejecutar CMD como administrador
# Verificar que la tarea programada use el usuario correcto
schtasks /query /tn "ImpresoraLocal-AutoUpdate" /fo table
```

### El servicio no inicia
```cmd
# Verificar que Node.js est√© funcionando
node --version

# Verificar que el puerto 4000 est√© libre
netstat -an | findstr :4000

# Reiniciar manualmente
C:\Users\Administrator\impresora-local\restart-impresora.bat
```

### Git no funciona
```cmd
# Verificar que Git est√© en el PATH
git --version

# Si no funciona, agregar Git al PATH manualmente
# Ruta t√≠pica: C:\Program Files\Git\bin
```

## üìû Soporte

Si encuentras problemas:

1. Revisa los logs del sistema
2. Verifica la conectividad a internet
3. Confirma que el repositorio GitHub sea accesible
4. Verifica que los scripts se ejecuten como administrador
5. Aseg√∫rate de que Git y Node.js est√©n instalados correctamente

## üîí Seguridad

- El servicio se ejecuta con el usuario actual
- Los logs se almacenan en el directorio del usuario
- Las configuraciones se preservan entre actualizaciones
- Solo se actualiza el c√≥digo, no la configuraci√≥n del sistema
- La tarea programada se ejecuta con permisos de administrador

## üéÆ Comandos √ötiles de Windows

### Gesti√≥n de Tareas Programadas
```cmd
# Ver todas las tareas
schtasks /query

# Ver tarea espec√≠fica
schtasks /query /tn "ImpresoraLocal-AutoUpdate"

# Eliminar tarea
schtasks /delete /tn "ImpresoraLocal-AutoUpdate" /f
```

### Gesti√≥n de Servicios PM2
```cmd
# Ver estado
pm2 status

# Ver logs
pm2 logs

# Reiniciar todo
pm2 restart all

# Guardar configuraci√≥n
pm2 save

# Configurar inicio autom√°tico
pm2 startup
```

---

**Nota**: El repositorio ya est√° configurado para usar `francoluca35/impresora-local` y la instalaci√≥n se realizar√° en `C:\Users\Administrador\impresora-local`.
